<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        #jstreeDiv {
            width: 400px;
            height: 600px;
            overflow: auto
        }


    </style>


    <script src="js/jquery/jquery.min.js"></script>
    <script src="js/others/d3/d3.v5.js" charset="utf-8"></script>
    <script src="js/graph/drawCanvas.js"></script>
    <script src="js/config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

    <script>
        clear = function () {
            $("#infosDiv").html("");
            $("#docsDiv").html("");
            $("#infosDiv").html("");
         //   $("#jstreeDiv").html("");
            $("#textDiv").html("");
        }
        drawHeatMap = function () {

            clear();

            var queryString = $("#queryStringInput").val();
           var entityQueryString= $("#entityQueryStringInput").val();
            if (queryString && queryString.length > 0) {

                var queryDocs = {
                    query: {
                        "query_string": {
                            "query": queryString,
                            "default_field": "attachment.content",
                            "default_operator": "AND"
                        }
                    },
                    size: 1000,
                    _source: "_id"

                }
                var payload = {
                    executeQuery: JSON.stringify(queryDocs),
                    indexes: JSON.stringify(["gmec_par"])

                }
                $.ajax({
                    type: "POST",
                    url: appConfig.elasticUrl,
                    data: payload,
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                        var xx = data;
                        var docIds = [];
                        data.hits.hits.forEach(function (hit) {
                            docIds.push(hit._id)
                        })
                        var query = {
                            terms: {
                                ["documents.id"]: docIds
                            }
                        }
                        drawCanvas.drawAll({onclickFn: onRectClick, query: query});
                    },
                    error: function (err) {
                        return console.log(err);
                    }
                })

            }
            if (entityQueryString && entityQueryString.length > 0) {

                var queryEntities = {query: {
                        "query_string": {
                            "query": entityQueryString,
                            "fields": ["internal_id", "synonyms"],
                            "default_operator": "AND"
                        }
                    }
                }
                var payload = {
                    executeQuery: JSON.stringify(queryEntities),
                    indexes: JSON.stringify(["thesaurus_ctg"])

                }
                $.ajax({
                    type: "POST",
                    url: appConfig.elasticUrl,
                    data: payload,
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                        var xx = data;
                        var docIds = [];
                        data.hits.hits.forEach(function (hit) {
                            hit._source.documents.forEach(function(doc){
                                docIds.push(doc.id)
                            })

                        })
                        var query = {
                            terms: {
                                ["documents.id"]: docIds
                            }
                        }
                        drawCanvas.drawAll({onclickFn: onRectClick, query: query});
                    },
                    error: function (err) {
                        return console.log(err);
                    }
                })


            } else {
                var query = {
                    "match_all": {}
                };
                drawCanvas.drawAll({onclickFn: onRectClick, query: query});

            }


        }
        var onRectClick = function (p, data) {
            var labels = drawCanvas.rawData.labels;
            var entity1 = labels[data.coords.x];
            var entity2 = labels[data.coords.y];
            var count = drawCanvas.rawData.data[data.coords.x][data.coords.y]
            var str = "<b>" + entity1 + " / <br>" + entity2 + "<br>" + count + " </b>"//<button onclick=showDocs('" + entity1 + "','" + entity2 + "')>X</button>"
            $("#infosDiv").html(str)
            showDocs(entity1, entity2)
        }

        var showDocs = function (entity1, entity2) {
            var query = {
                query: {
                    bool: {
                        must: [
                            {term: {"entities_thesaurus_ctg": entity1}},
                            {term: {"entities_thesaurus_ctg": entity2}},
                        ]
                    }
                }
                , size: 1000
            }

            var payload = {
                executeQuery: JSON.stringify(query),
                indexes: JSON.stringify(["gmec_par"])

            }
            $.ajax({
                type: "POST",
                url: appConfig.elasticUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var xx = data;

                    function docDataToJstree(data) {

                        var docs = {};
                        data.hits.hits.forEach(function (hit) {
                            var docAttrs = hit._source
                            if (!docs[docAttrs["docTitle"]]) {
                                docs[docAttrs["docTitle"]] = {chapters: {}, docId: docAttrs.docId}

                                if (!docs[docAttrs["docTitle"]].chapters[docAttrs["chapter"]]) {
                                    docs[docAttrs["docTitle"]].chapters[docAttrs["chapter"]] = {paragraphs: [], chapterId: docAttrs.chapterId}
                                }
                                docs[docAttrs["docTitle"]].chapters[docAttrs["chapter"]].paragraphs.push({text: docAttrs.text, paragraphId: docAttrs.paragraphId})
                            }


                        })

                        var jsTreeArray = [];
                        for (var docKey in docs) {
                            var doc = docs[docKey];
                            jsTreeArray.push({
                                text: docKey, id: doc.docId, parent: "#"
                            })
                            for (var chapterKey in doc.chapters) {
                                var chapter = doc.chapters[chapterKey];
                                jsTreeArray.push({
                                    text: chapterKey, id: chapter.chapterId, parent: doc.docId
                                })

                                chapter.paragraphs.forEach(function (paragraph) {
                                    jsTreeArray.push({
                                        text: paragraph.paragraphId, id: paragraph.paragraphId, parent: chapter.chapterId, data: {text: paragraph.text}
                                    })
                                })

                            }
                        }
                        return jsTreeArray;
                    }

                    var jsTreeArray = docDataToJstree(data);
                    drawJsTree("jstreeDiv", jsTreeArray)

                }
                , error: function (err) {

                    console.log(err.responseText)

                }

            });
        }
        drawJsTree = function (treeDiv, jsTreeData) {

            var plugins = [];
            plugins.push("search");

            plugins.push("sort");
            /*   plugins.push("types");
               plugins.push("contextmenu");*/

            if ($('#' + treeDiv).jstree)
                $('#' + treeDiv).jstree("destroy")

            $('#' + treeDiv).jstree({
                'core': {
                    'check_callback': true,
                    'data': jsTreeData,


                }
                , 'contextmenu': {
                    'items': null
                },
                'plugins': plugins,
                "search": {
                    "case_sensitive": false,
                    "show_only_matches": true
                }
            }).on("select_node.jstree",
                function (evt, obj) {
                    var x = obj;
                    var html = obj.node.text
                    if (obj.node.data && obj.node.data.text)
                        html = obj.node.data.text

                    $("#textDiv").html(html)
                    //   Entities.runEntityQuery(obj.node);
                    //   $("#dataDiv").html(JSON.stringify(obj.node.data,null,2))
                })
                .on('loaded.jstree', function () {
                    $("#" + treeDiv).jstree('open_all');
                });
        }


    </script>

</head>
<body>

<div style="display: flex;flex-direction: row;">
    <div id="center">

       word <input id="queryStringInput" style="width: 200px;">  <input id="entityQueryStringInput" style="width: 200px;">
        <button onclick="drawHeatMap()">draw</button>
        <div id="graphDiv" style="width:800px;height: 800px;"></div>
    </div>
    <div id="right">
        <span id="infosDiv"></span>
        <div id="docsDiv">  </div>
            <div id="jstreeDiv" style="width:300px; overflow: auto;height: 800px"></div>





    </div>

</div>
<div id="textDiv"></div>
</body>
<script>


</script>
</html>
